{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Catálogo de Contratos - Central de Contratos{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="catalog-hero py-5 bg-light">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8 mx-auto text-center">
                <div class="hero-content">
                    {% if current_category %}
                        <h1 class="display-4 fw-bold text-dark mb-3">{{ current_category.name }}</h1>
                        <p class="lead text-muted mb-4">{{ current_category.description }}</p>
                    {% else %}
                        <h1 class="display-4 fw-bold text-dark mb-4">Catálogo de Contratos</h1>
                        <p class="lead text-muted mb-4">
                            Escolha entre nossos modelos jurídicos profissionais, 
                            criados por especialistas e validados por advogados.
                        </p>
                    {% endif %}
                    <div class="stats-row d-flex justify-content-center gap-4 mt-4">
                        <div class="stat-item text-center">
                            <div class="stat-number h3 text-primary fw-bold">{{ contract_types|length }}</div>
                            <div class="stat-label small text-muted">
                                {% if current_category %}Contratos{% else %}Modelos{% endif %}
                            </div>
                        </div>
                        <div class="stat-item text-center">
                            <div class="stat-number h3 text-primary fw-bold">100%</div>
                            <div class="stat-label small text-muted">Jurídicos</div>
                        </div>
                        <div class="stat-item text-center">
                            <div class="stat-number h3 text-primary fw-bold">5min</div>
                            <div class="stat-label small text-muted">Para criar</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Categories Filter Section -->
<section class="categories-filter py-4 bg-white border-bottom">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <!-- Botão "Todos" -->
                    <a href="{% url 'contracts:catalog' %}" 
                       class="category-filter-btn {% if not current_category %}active{% endif %}">
                        <i class="fas fa-th-large me-2"></i>
                        Todos os Contratos
                    </a>
                    
                    <!-- Botões das Categorias -->
                    {% for category in categories %}
                        <a href="{% url 'contracts:catalog_category' category.slug %}" 
                           class="category-filter-btn {% if current_category.id == category.id %}active{% endif %}"
                           style="--category-color: {{ category.color }};">
                            <i class="{{ category.icon }} me-2"></i>
                            {{ category.name }}
                            <span class="badge">{{ category.get_contracts_count }}</span>
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contracts Grid -->
<section class="contracts-grid py-5">
    <div class="container">
        <div class="row g-4">
            {% for contract_type in contract_types %}
            <div class="col-xl-4 col-lg-6 col-md-6 col-sm-12">
                <div class="contract-card h-100">
                    <!-- Card Image/Icon -->
                    <div class="card-image-wrapper">
                        {% if contract_type.image %}
                            <img src="{{ contract_type.image.url }}" class="card-image" alt="{{ contract_type.name }}">
                        {% else %}
                            <div class="card-icon-placeholder">
                                {% if contract_type.slug == 'prestacao_servico' %}
                                    <i class="fas fa-handshake"></i>
                                {% elif contract_type.slug == 'locacao_residencial' %}
                                    <i class="fas fa-home"></i>
                                {% elif contract_type.slug == 'locacao_comercial' %}
                                    <i class="fas fa-building"></i>
                                {% elif contract_type.slug == 'compra_venda' %}
                                    <i class="fas fa-exchange-alt"></i>
                                {% elif contract_type.slug == 'confissao_divida' %}
                                    <i class="fas fa-file-invoice-dollar"></i>
                                {% elif contract_type.slug == 'freelancer' %}
                                    <i class="fas fa-laptop-code"></i>
                                {% else %}
                                    <i class="fas fa-file-contract"></i>
                                {% endif %}
                            </div>
                        {% endif %}
                        <div class="card-overlay">
                            <span class="badge-category">Jurídico</span>
                        </div>
                    </div>

                    <!-- Card Content -->
                    <div class="card-content">
                        <div class="card-header-section">
                            <h3 class="card-title">{{ contract_type.name }}</h3>
                            <p class="card-description">
                                {{ contract_type.description|truncatewords:15 }}
                            </p>
                        </div>

                        <div class="card-footer-section">
                            <div class="price-section">
                                <div class="price-wrapper">
                                    <span class="price-main">R$ {{ contract_type.price }}</span>
                                    <span class="price-suffix">único</span>
                                </div>
                                <div class="price-features">
                                    <span class="feature-item">
                                        <i class="fas fa-check-circle"></i>
                                        Personalização completa
                                    </span>
                                    <span class="feature-item">
                                        <i class="fas fa-download"></i>
                                        Download em PDF
                                    </span>
                                </div>
                            </div>

                            <div class="action-section">
                                <div class="d-flex gap-2">
                                    <!-- Botão Adicionar ao Carrinho -->
                                    <form method="post" action="{% url 'contracts:cart_add' contract_type.id %}" class="cart-form flex-grow-1">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-outline-custom w-100">
                                            <i class="fas fa-shopping-cart me-2"></i>
                                            <span class="btn-text">Adicionar</span>
                                        </button>
                                    </form>
                                    
                                    <!-- Botão Personalizar/Login -->
                                    {% if user.is_authenticated %}
                                        <a href="{{ contract_type.get_absolute_url }}" class="btn-outline-custom flex-grow-1">
                                            <span class="btn-text">Personalizar</span>
                                            <i class="fas fa-arrow-right btn-icon"></i>
                                        </a>
                                    {% else %}
                                        <a href="{% url 'users:login' %}?next={{ contract_type.get_absolute_url }}" class="btn-outline-custom flex-grow-1">
                                            <span class="btn-text">Fazer Login</span>
                                            <i class="fas fa-sign-in-alt btn-icon"></i>
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-12">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h3 class="empty-title">Nenhum contrato disponível</h3>
                    <p class="empty-description">Em breve teremos contratos disponíveis para você.</p>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- CTA Section for Non-Authenticated Users -->
{% if not user.is_authenticated %}
<section class="cta-section py-5 bg-primary">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <div class="cta-content">
                    <h2 class="cta-title text-white mb-3">Pronto para criar seu contrato?</h2>
                    <p class="cta-description text-white-50 mb-4">
                        Crie sua conta gratuita e tenha acesso a todos os nossos modelos profissionais.
                    </p>
                    <div class="cta-actions">
                        <a href="{% url 'users:register' %}" class="btn-white-custom me-3">
                            <i class="fas fa-user-plus me-2"></i>
                            Criar Conta Grátis
                        </a>
                        <a href="{% url 'users:login' %}" class="btn-outline-white-custom">
                            <i class="fas fa-sign-in-alt me-2"></i>
                            Já tenho conta
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Funcionalidade do carrinho de compras
document.querySelectorAll('.cart-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Mostrar loading
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adicionando...';
        submitBtn.disabled = true;
        
        // Fazer requisição AJAX
        fetch(this.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': this.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar sucesso temporariamente
                submitBtn.innerHTML = '<i class="fas fa-check me-2"></i>Adicionado!';
                submitBtn.classList.remove('btn-outline-custom');
                submitBtn.classList.add('btn-success');
                
                // Atualizar badge do carrinho
                updateCartBadge(data.cart_items);
                
                // Mostrar toast/notificação
                showToast(data.message, 'success');
                
                // Voltar ao estado normal após 2 segundos
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-outline-custom');
                    submitBtn.disabled = false;
                }, 2000);
            } else {
                // Mostrar erro
                showToast(data.message || 'Erro ao adicionar ao carrinho', 'error');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            showToast('Erro ao adicionar ao carrinho. Tente novamente.', 'error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        });
    });
});

// Função para atualizar badge do carrinho
function updateCartBadge(itemCount) {
    const badge = document.getElementById('cart-badge');
    if (badge) {
        if (itemCount > 0) {
            badge.textContent = itemCount;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
    }
}

// Função para mostrar notificações toast
function showToast(message, type = 'info') {
    // Criar toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} toast-notification`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        animation: slideInRight 0.3s ease-out;
    `;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    // Adicionar ao DOM
    document.body.appendChild(toast);
    
    // Remover automaticamente após 5 segundos
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Carregar quantidade atual do carrinho ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    fetch('{% url "contracts:cart_data" %}')
        .then(response => response.json())
        .then(data => {
            updateCartBadge(data.total_items);
        })
        .catch(error => {
            console.log('Erro ao carregar dados do carrinho:', error);
        });
});

// Adicionar CSS para animação
const style = document.createElement('style');
style.textContent = `
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .toast-notification {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
